name: Terraform Plan on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'environments/**'

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-envs:
    runs-on: ubuntu-latest
    outputs:
      altprod: ${{ steps.filter.outputs.altprod }}
      nonprod: ${{ steps.filter.outputs.nonprod }}
      prod: ${{ steps.filter.outputs.prod }}
      demo: ${{ steps.filter.outputs.demo }}
    steps:
      - uses: actions/checkout@v3

      - name: Detect changed environment folders
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            altprod:
              - 'environments/altprod/**'
            nonprod:
              - 'environments/nonprod/**'
            prod:
              - 'environments/prod/**'
            demo:
              - 'environments/demo/**'

  prepare-matrix:
    runs-on: ubuntu-latest
    needs: detect-envs
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix for changed environments
        id: set-matrix
        run: |
          environments=()
          if [[ "${{ needs.detect-envs.outputs.altprod }}" == "true" ]]; then
            environments+=("{\"environment\":\"altprod\"}")
          fi
          if [[ "${{ needs.detect-envs.outputs.nonprod }}" == "true" ]]; then
            environments+=("{\"environment\":\"nonprod\"}")
          fi
          if [[ "${{ needs.detect-envs.outputs.prod }}" == "true" ]]; then
            environments+=("{\"environment\":\"prod\"}")
          fi
          if [[ "${{ needs.detect-envs.outputs.demo }}" == "true" ]]; then
            environments+=("{\"environment\":\"demo\"}")
          fi

          matrix_json="{\"include\":[$(IFS=,; echo "${environments[*]}")]}"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix_json"

  plan:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      fail-fast: false
    name: Terraform Plan (${{ matrix.environment }})
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v3

      - name: Set secrets and config
        run: |
          if [[ "${{ matrix.environment }}" == "altprod" ]]; then
            echo "ARM_CLIENT_ID=${{ vars.ALTPROD_ARM_CLIENT_ID }}" >> $GITHUB_ENV
            echo "ARM_TENANT_ID=${{ vars.ALTPROD_ARM_TENANT_ID }}" >> $GITHUB_ENV
            echo "ARM_SUBSCRIPTION_ID=${{ vars.ALTPROD_ARM_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
            echo "STORAGE_ACCOUNT_NAME=${{ vars.ALTPROD_STORAGE_ACCOUNT_NAME }}" >> $GITHUB_ENV
            echo "CONTAINER_NAME=${{ vars.ALTPROD_CONTAINER_NAME }}" >> $GITHUB_ENV
            echo "RESOURCE_GROUP_NAME=${{ vars.ALTPROD_RESOURCE_GROUP_NAME }}" >> $GITHUB_ENV
            echo "TF_VAR_default_password=${{ secrets.ALTPROD_DEFAULT_PASSWORD }}" >> $GITHUB_ENV
            echo "ARM_CLIENT_SECRET=${{ secrets.ALTPROD_ARM_CLIENT_SECRET }}" >> $GITHUB_ENV
          elif [[ "${{ matrix.environment }}" == "nonprod" ]]; then
            echo "ARM_CLIENT_ID=${{ vars.NONPROD_ARM_CLIENT_ID }}" >> $GITHUB_ENV
            echo "ARM_TENANT_ID=${{ vars.NONPROD_ARM_TENANT_ID }}" >> $GITHUB_ENV
            echo "ARM_SUBSCRIPTION_ID=${{ vars.NONPROD_ARM_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
            echo "STORAGE_ACCOUNT_NAME=${{ vars.NONPROD_STORAGE_ACCOUNT_NAME }}" >> $GITHUB_ENV
            echo "CONTAINER_NAME=${{ vars.NONPROD_CONTAINER_NAME }}" >> $GITHUB_ENV
            echo "RESOURCE_GROUP_NAME=${{ vars.NONPROD_RESOURCE_GROUP_NAME }}" >> $GITHUB_ENV
            echo "TF_VAR_default_password=${{ secrets.NONPROD_DEFAULT_PASSWORD }}" >> $GITHUB_ENV
            echo "ARM_CLIENT_SECRET=${{ secrets.NONPROD_ARM_CLIENT_SECRET }}" >> $GITHUB_ENV
          elif [[ "${{ matrix.environment }}" == "prod" ]]; then
            echo "ARM_CLIENT_ID=${{ vars.PROD_ARM_CLIENT_ID }}" >> $GITHUB_ENV
            echo "ARM_TENANT_ID=${{ vars.PROD_ARM_TENANT_ID }}" >> $GITHUB_ENV
            echo "ARM_SUBSCRIPTION_ID=${{ vars.PROD_ARM_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
            echo "STORAGE_ACCOUNT_NAME=${{ vars.PROD_STORAGE_ACCOUNT_NAME }}" >> $GITHUB_ENV
            echo "CONTAINER_NAME=${{ vars.PROD_CONTAINER_NAME }}" >> $GITHUB_ENV
            echo "RESOURCE_GROUP_NAME=${{ vars.PROD_RESOURCE_GROUP_NAME }}" >> $GITHUB_ENV
            echo "TF_VAR_default_password=${{ secrets.PROD_DEFAULT_PASSWORD }}" >> $GITHUB_ENV
            echo "ARM_CLIENT_SECRET=${{ secrets.PROD_ARM_CLIENT_SECRET }}" >> $GITHUB_ENV
          elif [[ "${{ matrix.environment }}" == "demo" ]]; then
            echo "ARM_CLIENT_ID=${{ vars.DEMO_ARM_CLIENT_ID }}" >> $GITHUB_ENV
            echo "ARM_TENANT_ID=${{ vars.DEMO_ARM_TENANT_ID }}" >> $GITHUB_ENV
            echo "ARM_SUBSCRIPTION_ID=${{ vars.DEMO_ARM_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
            echo "STORAGE_ACCOUNT_NAME=${{ vars.DEMO_STORAGE_ACCOUNT_NAME }}" >> $GITHUB_ENV
            echo "CONTAINER_NAME=${{ vars.DEMO_CONTAINER_NAME }}" >> $GITHUB_ENV
            echo "RESOURCE_GROUP_NAME=${{ vars.DEMO_RESOURCE_GROUP_NAME }}" >> $GITHUB_ENV
            echo "TF_VAR_default_password=${{ secrets.DEMO_DEFAULT_PASSWORD }}" >> $GITHUB_ENV
            echo "ARM_CLIENT_SECRET=${{ secrets.DEMO_ARM_CLIENT_SECRET }}" >> $GITHUB_ENV
          fi

      - name: Install Terraform
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install terraform

      - name: Terraform Init
        run: terraform -chdir=src init -backend-config=storage_account_name=$STORAGE_ACCOUNT_NAME -backend-config=container_name=$CONTAINER_NAME -backend-config=key=${{ matrix.environment }} -backend-config=resource_group_name=$RESOURCE_GROUP_NAME -backend-config=subscription_id=$ARM_SUBSCRIPTION_ID -backend-config=tenant_id=$ARM_TENANT_ID
      
      - name: Terraform Plan
        run: terraform -chdir=src plan -var-file="../environments/${{ matrix.environment }}/terraform.tfvars"
